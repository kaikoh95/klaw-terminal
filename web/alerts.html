<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Klaw Terminal üêæ - Price Alerts</title>
  <link rel="stylesheet" href="/css/style.css">
  <style>
    .alert-form {
      background: rgba(255, 255, 255, 0.03);
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 2fr 2fr 2fr 3fr 1fr;
      gap: 1rem;
      align-items: end;
      margin-bottom: 1rem;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    
    .form-group label {
      font-size: 0.85rem;
      color: #999;
      font-weight: 500;
    }
    
    .form-group input,
    .form-group select {
      padding: 0.75rem;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      color: #fff;
      font-size: 0.95rem;
    }
    
    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #4a9eff;
    }
    
    .alert-item {
      background: rgba(255, 255, 255, 0.03);
      border-left: 3px solid #4a9eff;
      padding: 1rem;
      margin-bottom: 0.75rem;
      border-radius: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .alert-item.triggered {
      border-left-color: #00ff88;
      background: rgba(0, 255, 136, 0.05);
    }
    
    .alert-details {
      flex: 1;
    }
    
    .alert-ticker {
      font-size: 1.1rem;
      font-weight: 600;
      color: #4a9eff;
      margin-bottom: 0.25rem;
    }
    
    .alert-condition {
      font-size: 0.9rem;
      color: #ccc;
      margin-bottom: 0.25rem;
    }
    
    .alert-note {
      font-size: 0.85rem;
      color: #999;
      font-style: italic;
    }
    
    .alert-time {
      font-size: 0.8rem;
      color: #666;
    }
    
    .alert-actions {
      display: flex;
      gap: 0.5rem;
    }
    
    .btn-delete {
      padding: 0.5rem 1rem;
      background: rgba(255, 59, 59, 0.2);
      border: 1px solid #ff3b3b;
      color: #ff3b3b;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.2s;
    }
    
    .btn-delete:hover {
      background: rgba(255, 59, 59, 0.3);
    }
    
    .empty-state {
      text-align: center;
      padding: 3rem;
      color: #666;
    }
    
    .notification-banner {
      position: fixed;
      top: 20px;
      right: 20px;
      max-width: 400px;
      background: rgba(0, 255, 136, 0.95);
      color: #000;
      padding: 1rem 1.5rem;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0, 255, 136, 0.3);
      z-index: 1000;
      animation: slideIn 0.3s ease-out;
      display: none;
    }
    
    .notification-banner.show {
      display: block;
    }
    
    @keyframes slideIn {
      from {
        transform: translateX(120%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    .notification-title {
      font-weight: 600;
      font-size: 1rem;
      margin-bottom: 0.25rem;
    }
    
    .notification-message {
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <div class="notification-banner" id="notification">
    <div class="notification-title">üîî Price Alert Triggered!</div>
    <div class="notification-message" id="notificationMessage"></div>
  </div>

  <div class="container">
    <header>
      <h1>üêæ KLAW TERMINAL</h1>
      <p class="subtitle">AI-Powered Trading Intelligence</p>
      <nav>
        <a href="/">Dashboard</a>
        <a href="/signals.html">Signals</a>
        <a href="/analysis.html">Analysis</a>
        <a href="/screener.html">Screener</a>
        <a href="/heatmap.html">Heatmap</a>
        <a href="/performance.html">Performance</a>
        <a href="/risk.html">Risk</a>
        <a href="/alerts.html" class="active">Alerts</a>
        <a href="/sentiment.html">Sentiment</a>
        <a href="/news.html">News</a>
        <a href="/options.html">Options</a>
        <a href="/earnings.html">Earnings</a>
      </nav>
    </header>

    <div class="card">
      <h2>üîî Price Alerts</h2>
      <p style="color: #999; margin-bottom: 1.5rem;">
        Set price alerts to monitor key levels. Receive real-time notifications when prices breach your targets.
      </p>

      <div class="alert-form">
        <div class="form-row">
          <div class="form-group">
            <label>Ticker</label>
            <select id="tickerInput">
              <option value="SPY">SPY</option>
              <option value="SPX">SPX</option>
              <option value="QQQ">QQQ</option>
              <option value="ONDS">ONDS</option>
              <option value="USAR">USAR</option>
              <option value="HOVR">HOVR</option>
              <option value="RDDT">RDDT</option>
              <option value="UUUU">UUUU</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>Condition</label>
            <select id="conditionInput">
              <option value="above">Above</option>
              <option value="below">Below</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>Price</label>
            <input type="number" id="priceInput" placeholder="0.00" step="0.01" min="0">
          </div>
          
          <div class="form-group">
            <label>Note (optional)</label>
            <input type="text" id="noteInput" placeholder="e.g., Breakout level">
          </div>
          
          <div class="form-group">
            <label>&nbsp;</label>
            <button class="btn" onclick="addNewAlert()" id="addBtn">
              ‚ûï Add Alert
            </button>
          </div>
        </div>
      </div>

      <div id="activeAlertsSection">
        <h3>‚è∞ Active Alerts <span id="activeCount" class="badge">0</span></h3>
        <div id="activeAlerts">
          <div class="loading">Loading alerts...</div>
        </div>
      </div>

      <div id="triggeredAlertsSection" style="margin-top: 2rem;">
        <h3>‚úÖ Triggered Alerts <span id="triggeredCount" class="badge">0</span></h3>
        <div id="triggeredAlerts">
          <div class="loading">Loading alerts...</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let ws;
    
    // Initialize WebSocket for real-time alert notifications
    function initWebSocket() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const wsUrl = `${protocol}//${window.location.host}`;
      
      try {
        ws = new WebSocket(wsUrl);
        
        ws.onopen = () => {
          console.log('WebSocket connected');
        };
        
        ws.onmessage = (event) => {
          try {
            const message = JSON.parse(event.data);
            
            if (message.type === 'alert-triggered') {
              // Show notification for triggered alerts
              message.data.forEach(alert => {
                showNotification(alert);
              });
              
              // Reload alerts to show updated state
              loadAlerts();
            }
          } catch (error) {
            console.error('Error parsing WebSocket message:', error);
          }
        };
        
        ws.onerror = (error) => {
          console.error('WebSocket error:', error);
        };
        
        ws.onclose = () => {
          console.log('WebSocket disconnected, reconnecting...');
          setTimeout(initWebSocket, 3000);
        };
      } catch (error) {
        console.error('Failed to initialize WebSocket:', error);
        setTimeout(initWebSocket, 3000);
      }
    }
    
    // Show notification banner
    function showNotification(alert) {
      const banner = document.getElementById('notification');
      const message = document.getElementById('notificationMessage');
      
      message.textContent = `${alert.ticker} ${alert.condition === 'above' ? 'broke above' : 'fell below'} $${alert.price.toFixed(2)} at $${alert.triggeredPrice.toFixed(2)}`;
      
      banner.classList.add('show');
      
      // Play notification sound (if browser allows)
      try {
        const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUKno7rlbHAU5k9jz01ElByd4x/DejzsKFF+16eWnVhMIRaLg8L9qIQQsgc7y2Ik2CBxqvfDlnE0MD1Cp6O65XBwFOZPY89RRJQcneMfx3o87ChRftejlp1cTCESi3vC/aiEFLIHO8tiJNggbaL3w5ZxODA9QqejvuV0cBTmT2PXUUCQGJ3jH8d+POwkUX7Xo5adXEwhEot7wv2ohBSyBzvLYiTYIG2i98OScTgwPUKnn77pdHAY5k9jz1FAkBid5x/Hfjj0JFF+16OSoVxUIQ6Lf8L9pIAUsgs7y2Ik2CBtovfDlnE0MD1Cp6O+6XRwFOZPY9dVPJAYmecfw34c+ChNftejkp1cVB0Si3/C/aiEELILO8tiINggcaL3w5JxNDA5Rqejuul0cBTmT2PXVTyQGJnnH8d+HPgoTXrTo5KdXFQdEot/wv2ohBSuCzvLYiDYIHGi98OScTQwOUano77pdHAU5k9j11U8kBiZ5x/Hfhj4KFF+06OSnVxUHRKLf8L9qIQQrgs7y14g2CB1ovfDknE0MDlCp6O65XRwFOZPY9dVPJAYmecfx34c9ChRftOjkp1cVB0Si3/C/aiEEK4LO8teHNggcaL3w5JxNDA5Qp+jvul0cBTmT2PXUTiQGJnjH8d+HPgoUXrPo5KdXFAdEot/wv2ohBCuCzvLXhzYIHGi98OOcTQwPUKfo77ldHAU5k9j11E4kByZ4x/Hfhj4KFF+06OOmVxUHRKLe8L9qIAUrgs7y14c2CBxovfDjm00MDlCn6O+5XRwFOZPZ9dROJAcmeMfx34Y+ChRfs+jjplcVCESi3vC/aiEFK4LO8teGNgkdar3v45tNDA5Pp+jvuV0cBTmT2fXUTiQHJnjH8N+GPgoUX7Xo46ZXFAhDot7wv2ogBSuBzvHWhjYJHGq97+ObTQwOT6fo77pdHAU5k9n11UwjBiZ4x/Hfhj0KE1606OSsVBUIRKLe8LppIQUrg87y14U2CRxqve/im00MDk+n5+S6XRwGOJPZ9dVMIwYneMfx34c9ChNftOjkrFQWCEOi3vC6aR8FKn/O8daFNgkcar3v4ptNDA5Qp+fkul0cBjiU2PPUTCMGJnjH8d6HPQoTXrXo5KxUFghDot7wumkfBSp/zvHWhjYJHGq97+KbTQwOT6fn47lcHAU4lNjy1EwiBSZ4x/HeiD4KE1606OOsVBUIRKLe8Lpqbg==');
        audio.play().catch(() => {});
      } catch (e) {}
      
      // Auto-hide after 5 seconds
      setTimeout(() => {
        banner.classList.remove('show');
      }, 5000);
    }
    
    // Load all alerts
    async function loadAlerts() {
      try {
        // Load active alerts
        const activeRes = await fetch('/api/alerts/active');
        const activeData = await activeRes.json();
        
        if (activeData.success) {
          displayActiveAlerts(activeData.data);
        }
        
        // Load triggered alerts
        const triggeredRes = await fetch('/api/alerts/triggered?limit=20');
        const triggeredData = await triggeredRes.json();
        
        if (triggeredData.success) {
          displayTriggeredAlerts(triggeredData.data);
        }
      } catch (error) {
        console.error('Error loading alerts:', error);
      }
    }
    
    // Display active alerts
    function displayActiveAlerts(alerts) {
      const container = document.getElementById('activeAlerts');
      const countBadge = document.getElementById('activeCount');
      
      countBadge.textContent = alerts.length;
      
      if (alerts.length === 0) {
        container.innerHTML = '<div class="empty-state">No active alerts. Add one above to get started.</div>';
        return;
      }
      
      container.innerHTML = alerts.map(alert => `
        <div class="alert-item">
          <div class="alert-details">
            <div class="alert-ticker">${alert.ticker}</div>
            <div class="alert-condition">
              Notify when price goes <strong>${alert.condition}</strong> <strong>$${alert.price.toFixed(2)}</strong>
            </div>
            ${alert.note ? `<div class="alert-note">${alert.note}</div>` : ''}
            <div class="alert-time">Created ${new Date(alert.createdAt).toLocaleString()}</div>
          </div>
          <div class="alert-actions">
            <button class="btn-delete" onclick="deleteAlert('${alert.id}')">Delete</button>
          </div>
        </div>
      `).join('');
    }
    
    // Display triggered alerts
    function displayTriggeredAlerts(alerts) {
      const container = document.getElementById('triggeredAlerts');
      const countBadge = document.getElementById('triggeredCount');
      
      countBadge.textContent = alerts.length;
      
      if (alerts.length === 0) {
        container.innerHTML = '<div class="empty-state">No triggered alerts yet.</div>';
        return;
      }
      
      container.innerHTML = alerts.map(alert => `
        <div class="alert-item triggered">
          <div class="alert-details">
            <div class="alert-ticker">${alert.ticker}</div>
            <div class="alert-condition">
              Triggered: ${alert.condition} $${alert.price.toFixed(2)} at $${alert.triggeredPrice.toFixed(2)}
            </div>
            ${alert.note ? `<div class="alert-note">${alert.note}</div>` : ''}
            <div class="alert-time">
              Created ${new Date(alert.createdAt).toLocaleString()} ‚Ä¢ 
              Triggered ${new Date(alert.triggeredAt).toLocaleString()}
            </div>
          </div>
          <div class="alert-actions">
            <button class="btn-delete" onclick="deleteAlert('${alert.id}')">Clear</button>
          </div>
        </div>
      `).join('');
    }
    
    // Add new alert
    async function addNewAlert() {
      const ticker = document.getElementById('tickerInput').value;
      const price = parseFloat(document.getElementById('priceInput').value);
      const condition = document.getElementById('conditionInput').value;
      const note = document.getElementById('noteInput').value;
      const btn = document.getElementById('addBtn');
      
      if (!price || price <= 0) {
        alert('Please enter a valid price');
        return;
      }
      
      try {
        btn.disabled = true;
        btn.textContent = 'Adding...';
        
        const response = await fetch('/api/alerts', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ ticker, price, condition, note })
        });
        
        const result = await response.json();
        
        if (result.success) {
          // Clear form
          document.getElementById('priceInput').value = '';
          document.getElementById('noteInput').value = '';
          
          // Reload alerts
          loadAlerts();
        } else {
          alert('Error: ' + result.error);
        }
      } catch (error) {
        console.error('Error adding alert:', error);
        alert('Failed to add alert');
      } finally {
        btn.disabled = false;
        btn.textContent = '‚ûï Add Alert';
      }
    }
    
    // Delete alert
    async function deleteAlert(alertId) {
      if (!confirm('Delete this alert?')) return;
      
      try {
        const response = await fetch(`/api/alerts/${alertId}`, {
          method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.success) {
          loadAlerts();
        } else {
          alert('Error: ' + result.error);
        }
      } catch (error) {
        console.error('Error deleting alert:', error);
        alert('Failed to delete alert');
      }
    }
    
    // Initialize
    initWebSocket();
    loadAlerts();
    
    // Refresh alerts every 30 seconds
    setInterval(loadAlerts, 30000);
  </script>
</body>
</html>
