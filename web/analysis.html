<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Klaw Terminal üêæ - Technical Analysis</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <div class="container">
    <header>
      <h1>üêæ KLAW TERMINAL</h1>
      <p class="subtitle">AI-Powered Trading Intelligence</p>
      <nav>
        <a href="/">Dashboard</a>
        <a href="/signals.html">Signals</a>
        <a href="/analysis.html" class="active">Analysis</a>
      </nav>
    </header>

    <div class="card">
      <h2>Technical Analysis <button class="btn-small" onclick="loadAnalysis()">‚Üª Refresh</button></h2>
      <div id="analysisGrid" class="analysis-grid">
        <div class="loading">Loading analysis...</div>
      </div>
    </div>

    <footer>
      <p>Last updated: <span id="lastUpdate">--</span></p>
      <p>üêæ Maine Klaw Terminal v1.0</p>
    </footer>
  </div>

  <script src="/js/app.js"></script>
  <script>
    async function loadAnalysis() {
      const container = document.getElementById('analysisGrid');
      container.innerHTML = '<div class="loading">Loading analysis...</div>';
      
      try {
        const response = await fetch('/api/latest-scan');
        const result = await response.json();
        
        if (!result.success) {
          container.innerHTML = '<div class="empty-state">No analysis data available. Run `node bin/scan.js` first.</div>';
          return;
        }
        
        const { marketData, technicals } = result.data;
        
        let html = '';
        
        for (const [ticker, analysis] of Object.entries(technicals)) {
          if (!analysis) continue;
          
          const market = marketData[ticker];
          const changeClass = market.change >= 0 ? 'positive' : 'negative';
          const trendClass = getTrendClass(analysis.trend);
          
          html += `
            <div class="analysis-card">
              <div class="analysis-header">
                <h3>${ticker}</h3>
                <div class="price ${changeClass}">
                  $${analysis.price.toFixed(2)}
                  <span class="change">${market.change >= 0 ? '+' : ''}${market.changePercent.toFixed(2)}%</span>
                </div>
              </div>
              
              <div class="analysis-body">
                <div class="trend-badge ${trendClass}">
                  ${formatTrend(analysis.trend)}
                </div>
                
                <div class="indicators">
                  <div class="indicator">
                    <span class="label">RSI(14)</span>
                    <span class="value ${getRSIClass(analysis.rsi)}">${analysis.rsi ? analysis.rsi.toFixed(2) : '--'}</span>
                  </div>
                  
                  ${analysis.macd ? `
                    <div class="indicator">
                      <span class="label">MACD</span>
                      <span class="value ${analysis.macd.histogram > 0 ? 'positive' : 'negative'}">
                        ${analysis.macd.histogram.toFixed(2)}
                      </span>
                    </div>
                  ` : ''}
                  
                  ${analysis.vwap ? `
                    <div class="indicator">
                      <span class="label">VWAP</span>
                      <span class="value">$${analysis.vwap.toFixed(2)}</span>
                    </div>
                  ` : ''}
                  
                  ${analysis.movingAverages.sma20 ? `
                    <div class="indicator">
                      <span class="label">SMA(20)</span>
                      <span class="value">$${analysis.movingAverages.sma20.toFixed(2)}</span>
                    </div>
                  ` : ''}
                  
                  ${analysis.movingAverages.sma50 ? `
                    <div class="indicator">
                      <span class="label">SMA(50)</span>
                      <span class="value">$${analysis.movingAverages.sma50.toFixed(2)}</span>
                    </div>
                  ` : ''}
                  
                  ${analysis.bollingerBands ? `
                    <div class="indicator">
                      <span class="label">BB Upper</span>
                      <span class="value">$${analysis.bollingerBands.upper.toFixed(2)}</span>
                    </div>
                    <div class="indicator">
                      <span class="label">BB Lower</span>
                      <span class="value">$${analysis.bollingerBands.lower.toFixed(2)}</span>
                    </div>
                  ` : ''}
                </div>
                
                ${analysis.volume.unusual ? `
                  <div class="alert">
                    üìä Unusual Volume: ${analysis.volume.ratio.toFixed(2)}x (${analysis.volume.level})
                  </div>
                ` : ''}
                
                ${analysis.supportResistance.resistance.length > 0 ? `
                  <div class="levels">
                    <strong>Resistance:</strong> ${analysis.supportResistance.resistance.map(r => '$' + r.toFixed(2)).join(', ')}
                  </div>
                ` : ''}
                
                ${analysis.supportResistance.support.length > 0 ? `
                  <div class="levels">
                    <strong>Support:</strong> ${analysis.supportResistance.support.map(s => '$' + s.toFixed(2)).join(', ')}
                  </div>
                ` : ''}
              </div>
            </div>
          `;
        }
        
        container.innerHTML = html;
        updateTimestamp();
        
      } catch (error) {
        console.error('Failed to load analysis:', error);
        container.innerHTML = '<div class="empty-state">Failed to load analysis</div>';
      }
    }
    
    function getTrendClass(trend) {
      if (trend.includes('uptrend')) return 'bullish';
      if (trend.includes('downtrend')) return 'bearish';
      return 'neutral';
    }
    
    function formatTrend(trend) {
      return trend.replace(/_/g, ' ').toUpperCase();
    }
    
    function getRSIClass(rsi) {
      if (!rsi) return '';
      if (rsi > 70) return 'overbought';
      if (rsi < 30) return 'oversold';
      return '';
    }
    
    // Initial load
    loadAnalysis();
    
    // Auto-refresh every 60 seconds
    setInterval(loadAnalysis, 60000);
  </script>
</body>
</html>
